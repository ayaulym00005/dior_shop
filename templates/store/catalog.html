{% extends 'store/base.html' %}

{% load static %}

{%block link%}
<link rel="stylesheet" href="{% static 'store/css/catalog/styles.css' %}">
{%endblock%}
{% block title %}Каталог | Dior Shop{% endblock %}

{% block content %}
<div class="catalog-container">
    <h1 class="catalog-title">Наш каталог</h1>
    <div class="product-grid">
        {% for product in products %}
        <div class="product-card">
            
            <img src="http://127.0.0.1:8000/static/{{ product.image }}" alt="{{ product.name }}" class="product-image">
            <div class="product-details">
                <h3 class="product-name">{{ product.name }}</h3>
                <p class="product-description">{{ product.description|truncatechars:50 }}</p>
                <p class="product-price">{{ product.price }} ₸</p>
                <button class="add-to-cart-btn" data-product-id="{{ product.id }}">Добавить в корзину</button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Модальное окно -->
<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <p id="modal-message"></p>
    </div>
</div>

<!-- CSRF токен -->
<input type="hidden" id="csrf_token" value="{{ csrf_token }}">

{% endblock %}

{% block extra_js %}
<script>
    // Открытие модального окна с сообщением
    function openModal(message) {
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        modalMessage.textContent = message;
        modal.style.display = 'flex';
    }

    // Закрытие модального окна
    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    // Добавление товара в корзину
    async function addToCart(productId) {
        const csrfToken = document.getElementById('csrf_token').value;
        
        try {
            const response = await fetch("{% url 'add_to_cart' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ product_id: productId })
            });

            if (response.ok) {
                const data = await response.json();
                openModal(data.message);  
            } else {
                openModal('Ошибка при добавлении товара в корзину.');
            }
        } catch (error) {
            openModal('Произошла ошибка. Попробуйте позже.');
        }
    }

    // Обработчик события для кнопок "Добавить в корзину"
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.add-to-cart-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                const productId = event.target.getAttribute('data-product-id');
                addToCart(productId);
            });
        });
    });
</script>
{% endblock %}
